import { GoogleGenAI, createUserContent, createPartFromUri } from "@google/genai";
import { getSecret } from 'wix-secrets-backend';
import axios from 'axios';


export async function generateTextFromAudio(audioUrl) {
  if (!audioUrl || typeof audioUrl !== "string") {
    throw new Error("La URL de audio no es v√°lida");
  }

  const apiKey = await getSecret("GEMINI_API_KEY");
  const ai = new GoogleGenAI({ apiKey });

  try {
    // Usa fetch compatible con el entorno Wix
    const response = await fetch(audioUrl);
    const blob = await response.blob(); 

    console.log("Audio descargado y convertido a Blob");

    // Sube el archivo a Google Gemini usando el blob directamente
    const uploadedFile = await ai.files.upload({
      file: blob,
      config: { mimeType: "audio/mpeg" }
    });

    console.log("Archivo subido a Gemini:", uploadedFile);

    const result = await ai.models.generateContent({
      model: "gemini-2.0-flash",
      contents: createUserContent([
        createPartFromUri(uploadedFile.uri, "audio/mpeg"),
        "Transcribe lo que se dice en este archivo de audio."
      ])
    });

    const transcription = result.text;
    return transcription;

  } catch (error) {
    console.error("Error al transcribir:", error);
    throw new Error("No se pudo procesar el audio.");
  }
}